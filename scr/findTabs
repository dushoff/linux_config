#! /usr/bin/perl
## findTab.pl
## usage findTab appName tabName maxTabs
use strict;

my ($appName, $tabName, $maxTabs) = @ARGV;

$maxTabs = 0 unless defined $maxTabs;
$tabName = "." unless defined $tabName;

# --- current desktop (for ranking) ---
my $CURRENT_DESKTOP = `xdotool get_desktop`;
chomp $CURRENT_DESKTOP;

# --- cache for per-window desktop lookups ---
my %DESK_CACHE;

sub get_desktop {
    my ($win) = @_;
    return $DESK_CACHE{$win} if exists $DESK_CACHE{$win};
    my $d = `xdotool get_desktop_for_window $win`;
    chomp $d;
    $DESK_CACHE{$win} = $d;
    return $d;
}

# Rank: -1 => on current desktop; 0 => sticky (-1); else => that desktop number
sub desktop_rank {
    my ($win) = @_;
    my $d = get_desktop($win);

    # Defensive fallback if parsing fails
    return 9999 unless defined $d && length $d;

    return -1 if $d eq $CURRENT_DESKTOP;  # current desktop first
    return 0  if $d eq '-1';              # sticky windows next
    return $d if $d =~ /^-?\d+$/;         # then actual desktop number
    return 9999;                          # anything weird goes last
}

# --- search by both name and class, then de-duplicate ---
my @by_name  = split /\s+/, `xdotool search --name "$appName" 2>/dev/null`;
my @by_class = split /\s+/, `xdotool search --class "$appName" 2>/dev/null`;

my %seen;
my @wins = grep { $_ ne '' && !$seen{$_}++ } (@by_name, @by_class);

# --- sort: current-desktop first, then sticky, then others by desktop index ---
@wins = sort { desktop_rank($a) <=> desktop_rank($b) } @wins;

foreach my $win (@wins){
    my $title;
    for (my $i=0;$i<$maxTabs;$i++){
        ## print `xwininfo -id $win`;
        last if `xwininfo -id $win | grep $tabName`;
        system ("xdotool windowactivate $win");
        system("xdotool key --window $win ctrl+Tab");
    }
    if (`xwininfo -id $win | grep $tabName`){
        system ("xdotool windowactivate $win");
        last;
    }
}
